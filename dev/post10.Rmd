---
title: "R Notebook"
---

```{r, message=FALSE}
library(openprescribingR)
library(tidyverse)
library(sf)
library(ggiraph)
library(stringr)
library(deldir)
library(rgdal)
```

```{r}
ccggeom <- CCG_boundaries_or_location(as_sf = TRUE) 
#ccggeom without empty geoms
ccggeom <- ccggeom[c(!is.na(st_dimension(st_sfc(ccggeom$geometry)))),]
#centroids
ccggeom <- ccggeom %>%
mutate(
    lon = map_dbl(geometry, ~st_centroid(.x)[[1]]),
    lat = map_dbl(geometry, ~st_centroid(.x)[[2]])
    )
```

```{r}
#list <- list_size()
#list <- list[list$row_name %in% ccggeom$name,]
#list <- list$row_id %>%
#  unique() %>%
#  as.character()

#clinics <- lapply(list, function (x){
#  location_function(CCG_code = x, as_sf = TRUE)
#} )

#save(clinics, file="clinics.Rda")
load("clinics.Rda")
```

```{r}
nc_centroids <- st_centroid(ccggeom)
bbox_polygon <- function(x) {
  bb <- sf::st_bbox(x)
  p <- matrix(
    c(bb["xmin"], bb["ymin"], 
      bb["xmin"], bb["ymax"],
      bb["xmax"], bb["ymax"], 
      bb["xmax"], bb["ymin"], 
      bb["xmin"], bb["ymin"]),
    ncol = 2, byrow = T
  )
  sf::st_polygon(list(p))
}
box <- st_sfc(bbox_polygon(nc_centroids))
v <- st_voronoi(st_union(nc_centroids), box)

blep <- st_intersection(st_cast(v), st_union(ccggeom)) %>%
  as_Spatial() %>%
  fortify()
```

```{r}
ccggeom %>%
ggplot() +
  geom_polygon_interactive(data = blep, aes(x = long, y = lat, group = group)) +
  coord_sf(crs= 4326, datum = sf::st_crs(4326)) +
  geom_point(aes(x = lon, y = lat), color = "grey", size=0.1)
```

```{r}
cliniclist <- do.call("rbind", clinics)
cliniclist2 <- cliniclist %>%
  filter(org_type == "clinic")
```

```{r}
example2 <- fortify(as_Spatial(ccggeom$geometry))

ccggeom$id <- str_c("ID", 1:207)

for (i in 1:length(ccggeom$id)){
example2$name[!is.na(match(example2$id, ccggeom$id[i]))] <- as.character(ccggeom$name[i])
}
```

```{r}
veronoi <- deldir(ccggeom$lon, ccggeom$lat)
```

```{r}
gg_point =  ggplot(ccggeom) +
  geom_sf() +
  geom_point_interactive(aes(x = lon, y = lat, tooltip = name)) +
  coord_sf(crs= 4326, datum = sf::st_crs(4326))
ggiraph(code = {print(gg_point)}, width_svg = 17.07, height_svg = 13.46)
```

#Plot 1
```{r}
gg_point =  ggplot(ccggeom) +
  geom_polygon_interactive(data = example2, aes(x = long, y = lat, group = group, tooltip = name)) +
  coord_sf(crs= 4326, datum = sf::st_crs(4326))
ggiraph(code = {print(gg_point)}, width_svg = 17.07, height_svg = 13.46)
```

#Plot 2
```{r}
gg_point =  ggplot(ccggeom) +
  geom_polygon_interactive(data = example2, aes(x = long, y = lat, group = group, tooltip = name)) +
  geom_sf(data=cliniclist2, color = "grey", size=0.1) +
  coord_sf(crs= 4326, datum = sf::st_crs(4326))
ggiraph(code = {print(gg_point)}, width_svg = 17.07, height_svg = 13.46)
#htmlwidgets::saveWidget()
```

```{r}
nc_centroids <- cliniclist2$geometry
bbox_polygon <- function(x) {
  bb <- sf::st_bbox(x)
  p <- matrix(
    c(bb["xmin"], bb["ymin"], 
      bb["xmin"], bb["ymax"],
      bb["xmax"], bb["ymax"], 
      bb["xmax"], bb["ymin"], 
      bb["xmin"], bb["ymin"]),
    ncol = 2, byrow = T
  )
  sf::st_polygon(list(p))
}
box <- st_sfc(bbox_polygon(nc_centroids))
v <- st_voronoi(st_union(nc_centroids), box)

blep2 <- st_intersection(st_cast(v), st_union(ccggeom)) %>%
#blep2 <- st_intersection(st_cast(v), st_union(cliniclist2$geometry)) %>%
  as_Spatial() %>%
  fortify()
```

```{r}
gg_point =  ggplot(ccggeom) +
  geom_polygon_interactive(data = blep2, aes(x = long, y = lat, group = group)) +
  geom_sf(data=cliniclist2, color = "grey", size=0.1) +
  coord_sf(crs= 4326, datum = sf::st_crs(4326))
ggiraph(code = {print(gg_point)}, width_svg = 17.07, height_svg = 13.46)
```

class(st_geometry(ccggeom))
also works with; example1 <- as_Spatial(ccggeom$geometry)
coord_sf(crs= 4326, datum = sf::st_crs(4326))

Replacing geom_sf with geom_polygon
```{r}
ccggeom %>%
ggplot() +
  geom_polygon_interactive(data = example2, aes(x = long, y = lat, group = group)) +
  coord_sf(crs= 4326, datum = sf::st_crs(4326)) +
  geom_segment(
    aes(x = x1, y = y1, xend = x2, yend = y2),
    size = 0.25,
    data = veronoi$dirsgs,
    linetype = 1,
    color= "#18515E") +
  geom_point(aes(x = lon, y = lat), color = "grey")
```

```{r}
vor_desc <- tile.list(veronoi)
lapply(1:(length(vor_desc)), function(i) {
    tmp <- cbind(vor_desc[[i]]$x, vor_desc[[i]]$y)
    tmp <- rbind(tmp, tmp[1,])
    Polygons(list(Polygon(tmp)), ID=i)
  }) -> vor_polygons

st_voronoi(ccggeom)
```

```{r}
gg_point =  filter(dataframe, date == "2017-05-01") %>%
  ggplot() +
  geom_sf(aes(fill = costperperson)) +
  geom_point_interactive(aes(x = lon, y = lat, tooltip = label)) +
  theme(legend.position="none")
ggiraph(code = {print(gg_point)}, width_svg = 17.07, height_svg = 13.46)
```

rest on post 6. 
```{r, message=FALSE}
spendingdata <- spending_by_practice(BNF_section_code = "2.12", practice_code = "G82732")
spendingdata$date <- as.Date(spendingdata$date)

ccgpracticespendingdata <- spending_by_practice(BNF_section_code = "2.12", CCG_code = "99J")
ccgpracticespendingdata$date <- as.Date(ccgpracticespendingdata$date)

CCGdata <- location_function(CCG_code = "99J", as_sf = TRUE) %>%
mutate(
    lon = map_dbl(geometry, ~st_centroid(.x)[[1]]),
    lat = map_dbl(geometry, ~st_centroid(.x)[[2]])
    )
CCGdata$name <- str_replace_all(CCGdata$name, "'", " ")
ccgpracticespendingdata2 <- spending_by_practice(BNF_section_code = "2.12", CCG_code = "99J") %>%
  group_by(date) %>% 
  summarise(`Q1`=quantile(actual_cost, probs=0.25),
            `Q2`=quantile(actual_cost, probs=0.5),
            `Q3`=quantile(actual_cost, probs=0.75),
            `Min`=min(actual_cost),
            `Max`=max(actual_cost),
            `Total`=sum(actual_cost)) %>%
  mutate(Clinic = spendingdata[, 'actual_cost'])
ccgpracticespendingdata2$date <- as.Date(ccgpracticespendingdata2$date)

tidyr <- ccgpracticespendingdata2 %>%
  gather(key = group, value = actual_cost, -date, -Total) %>%
  select(-Total) %>%
  mutate(label = str_c(date, ": ", group, ", Â£", actual_cost))
tidyr$date <- as.Date(tidyr$date)
```

```{r}
gg_point = ggplot(CCGdata) +
  geom_sf(data = CCGdata[1,]) +
  geom_point_interactive(data = CCGdata[2:86,], aes(x = lon, y = lat, tooltip = name)) +
  geom_point_interactive(data = CCGdata[57,], aes(x = lon, y = lat, tooltip = name), colour = "red") +
  geom_text(data = CCGdata[57,], aes(x=lon, y=lat, label=name), hjust = 0, nudge_x = 0.05) + 
  theme(legend.position="none") +
  coord_sf(crs= 4326, datum = sf::st_crs(4326))

ggiraph(code = {print(gg_point)}, width_svg = 17.07, height_svg = 14.75)
```

```{r}
gg_point = ggplot(spendingdata) +
  geom_ribbon(data = ccgpracticespendingdata2, 
              aes(x = date, ymin = Min, ymax = Max), alpha=0.75, fill = "grey80") +
  geom_ribbon(data = ccgpracticespendingdata2, 
              aes(x = date, ymin = Q1, ymax = Q3), alpha=0.75, fill = "grey70") +
  geom_line_interactive(data = filter(tidyr, group=="Q3"|group=="Q1"),
            aes(x= date, y=actual_cost, group=group, colour=group, tooltip = label), colour = "grey70") +
  geom_line_interactive(data = filter(tidyr, group=="Max"|group=="Min"),
            aes(x= date, y=actual_cost, group=group, colour=group, tooltip = label), colour = "grey80") +
  geom_line_interactive(data = filter(tidyr, group=="Clinic"|group=="Q2"),
            aes(x= date, y=actual_cost, group=group, colour=group, tooltip = label), alpha=0.5, size=2) + 
  theme(axis.text.x=element_text(angle=45, hjust = 1)) +
  labs(title="Actual_cost on 'BNF Section 2.12 Drugs - Lipid-Regulating Drugs'")

ggiraph(code = {print(gg_point)}, width_svg = 17.07, height_svg = 7.375)
```

```{r}
gg_point = ggplot(spendingdata) +
  geom_ribbon(data = ccgpracticespendingdata2, 
              aes(x = date, ymin = Min, ymax = Max), alpha=0.75, fill = "grey80") +
  geom_ribbon(data = ccgpracticespendingdata2, 
              aes(x = date, ymin = Q1, ymax = Q3), alpha=0.75, fill = "grey70") +
  geom_line_interactive(data = filter(tidyr, group=="Q3"|group=="Q1"),
            aes(x= date, y=actual_cost, group=group, colour=group, tooltip = label), colour = "grey70") +
  geom_line_interactive(data = filter(tidyr, group=="Max"|group=="Min"),
            aes(x= date, y=actual_cost, group=group, colour=group, tooltip = label), colour = "grey80") +
  geom_line_interactive(data = filter(tidyr, group=="Clinic"|group=="Q2"),
            aes(x= date, y=actual_cost, group=group, colour=group, tooltip = label), alpha=0.5, size=2) + 
  theme(axis.text.x=element_text(angle=45, hjust = 1)) +
  labs(title="Actual_cost on 'BNF Section 2.12 Drugs - Lipid-Regulating Drugs'")

ggiraph(code = {print(gg_point)}, width_svg = 17.07, height_svg = 7.375)
```



gg_point = ccgpracticespendingdata %>%
  ggplot() +
  geom_step_interactive(aes(x= date, y=actual_cost, group=row_id, tooltip = label)) +
  geom_step_interactive(data = filter(tidyr, group=="Clinic"|group=="Q2"),
            aes(x= date, y=actual_cost, group=group, colour=group, tooltip = label), 
            size=2) + 
  geom_text(data = filter(ccgpracticespendingdata, date == "2017-05-01"), aes(label = row_id, x=date, y=actual_cost, 
    vjust = 1, hjust = 0, angle=45)) +
  theme(axis.text.x=element_text(angle=45, hjust = 1)) +
  labs(title="Actual_cost spending on 'BNF Section 2.12 Drugs - Lipid-Regulating Drugs'")

ggiraph(code = {print(gg_point)})

N.B no geom_step_interactive function.

```{r}
ccgpracticespendingdata$date <- as.Date(ccgpracticespendingdata$date)
ccgpracticespendingdata <- ccgpracticespendingdata %>%
  mutate(label = str_c(date, ": ", row_name, ", ", actual_cost))

ccgpracticespendingdata2 <- ccgpracticespendingdata2 %>%
  mutate(label = str_c(date, ": ", row_name, ", ", actual_cost))

ccgpracticespendingdata$label <- str_replace_all(ccgpracticespendingdata$label, "'", " ")
tidyr$label <- str_replace_all(tidyr$label, "'", " ")
```


```{r}
gg_point = ccgpracticespendingdata %>%
  ggplot() +
   geom_ribbon(data = ccgpracticespendingdata2, 
              aes(x = date, ymin = Min, ymax = Max), fill = "grey80", alpha=0.75) +
  geom_ribbon(data = ccgpracticespendingdata2, 
              aes(x = date, ymin = Q1, ymax = Q3), fill = "grey70", alpha=0.75) +
  
  
  geom_line_interactive(aes(group = row_id, x=date, y=actual_cost, tooltip = label)) +
  
  geom_line_interactive(data = filter(tidyr, group=="Clinic"|group=="Q2"),
            aes(x= date, y=actual_cost, group=group, colour=group, tooltip = label), 
            size=2) + 
  
  
  geom_text(data = filter(ccgpracticespendingdata, date == "2017-05-01"), aes(label = row_id, x=date, y=actual_cost, 
    vjust = 1, hjust = 0, angle=45)) +
  theme(axis.text.x=element_text(angle=45, hjust = 1)) +
  labs(title="Actual_cost spending on 'BNF Section 2.12 Drugs - Lipid-Regulating Drugs'")

ggiraph(code = {print(gg_point)}, width_svg = 17.07, height_svg = 7.375)
```

ggiraph(code = {print(gg_point)}, width_svg = 17.07, height_svg = 8.12)
http://auctionrepair.com/pixels.html

