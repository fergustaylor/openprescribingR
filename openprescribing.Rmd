---
title: "R Notebook"
output: html_notebook
---

```{r, message=FALSE, warning=FALSE}
#install.packages("RCurl")
library(RCurl)
library(tidyverse)
library(stringr)
```

Using the (beta) RESTful API and a few lines of R, I can create a small function to download and import OpenPrescribing data directly into RStudio.
You could still download it onto your desktop directly from the API, but I think that doing this in-studio makes it much easier to update the information.

Further explanation on the terms used here - [https://openprescribing.net/api/](https://openprescribing.net/api/)

Essential reading [https://openprescribing.net/api/](https://openprescribing.net/caution/)

#Spending
Retrieve total spending and items by CCG or practice on a particular chemical, presentation or BNF section. (Spending is calculated using the actual_cost field in the HSCIC data, items using the total_items field.)

##Spending by code
Queries from August 2010 to date and returns total spending and items by month
E.g Total prescribing spending by month = spending_by_code() 
or 
Total by BNF code by month = spending_by_code(BNF_code = "...")
```{r}
spending_by_code <- function(BNF_code = NULL){
if (!is.null(BNF_code)) {variablesegment <- str_c("?code=", BNF_code)} 
else {variablesegment <- "?format=api"}
str_c("https://openprescribing.net/api/1.0/", "spending/", variablesegment, "&format=csv") %>%
getURL() %>%
textConnection() %>%
read.csv()
}
```

#For example
```{r}
spending_by_code(BNF_code = "0212")
```


##Spending by CCG
Queries from April 2013 to date and returns spending and items by CCG by month.
E.g Spending by CCG on a chemical = spending_by_CCG(chemical_code = "...")
or
Individual CCGs by code (+/- on a chemical) = spending_by_CCG(CCG_code = "...")
```{r}
spending_by_CCG <- function(chemical_code = NULL, CCG_code = NULL){
if (!is.null(chemical_code) & is.null(CCG_code)) {variablesegment <- str_c("code=", chemical_code)} 
if (!is.null(CCG_code) & is.null(chemical_code)) {variablesegment <- str_c("&org=", CCG_code)}
if (!is.null(CCG_code) & !is.null(CCG_code)) {variablesegment <- str_c("code=", chemical_code, "&org=", CCG_code)}
if (is.null(chemical_code) & is.null(CCG_code)) {warning("chemical_code and/or CCG_code required")}
str_c("https://openprescribing.net/api/1.0/", "spending_by_ccg/?", variablesegment, "&format=csv") %>%
getURL() %>%
textConnection() %>%
read.csv()
}
```

##Spending by practice
Queries from August 2010 to date and returns total spending and items by practice by month.
You must specify either an organisation, or a date.
E.g Spending by all practices on a BNF section = spending_by_practice(BNF_section_code = "...")
Or
Spending by all practices on a chemical = spending_by_practice(chemical_code = "...")
Or
Spending by all practices on a presentation = spending_by_practice(presentation_code = "...")
Or
Spending by an individual practice = spending_by_practice(practice_code = "...")
Or
Spending by all practices in a CCG = spending_by_practice(CCG_code = "...")

Or a variation of the above (with at least 1 practice_code, date_code, or CCG_code).
```{r}
spending_by_practice <- function(BNF_section_code = NULL, chemical_code = NULL, presentation_code = NULL, practice_code = NULL, CCG_code = NULL, date_code = NULL){
  if (!is.null(BNF_section_code)){variablesegment1 <- str_c("&code=", BNF_section_code)}
  if (!is.null(chemical_code)){variablesegment2 <- str_c("&code=", chemical_code)} 
  if (!is.null(presentation_code)){variablesegment3 <- str_c("&code=", presentation_code)}
  if (!is.null(practice_code)){variablesegment4 <- str_c("&org=", practice_code)} 
  if (!is.null(CCG_code)){variablesegment5 <- str_c("&org=", CCG_code)} 
  if (!is.null(date_code)){variablesegment6 <- str_c("&date=", date_code)} 
  if (is.null(practice_code) & is.null(date_code) & is.null(CCG_code)){warning("You must specify either an organisation (practice_code), or a date (date_code).")}
  variablesegment <- str_c(
  if(exists("variablesegment1")){variablesegment1},
  if(exists("variablesegment2")){variablesegment2},
  if(exists("variablesegment3")){variablesegment3},
  if(exists("variablesegment4")){variablesegment4},
  if(exists("variablesegment5")){variablesegment5},
  if(exists("variablesegment6")){variablesegment6})
str_c("https://openprescribing.net/api/1.0/", "spending_by_practice/?", variablesegment, "&format=csv") %>%
getURL() %>%
textConnection() %>%
read.csv()
}
```

#For example
```{r}
spending_by_practice(BNF_section_code = "0212", date_code = "2015-04-01")
spending_by_practice(presentation_code = "0212000AAAAAAAA") 
```

#Information
Methods to retrieve information about CCGs, practices, and BNF codes.

##Drug Details
Search for the official name and code of BNF sections, chemicals and presentations.
E.g All BNF sections, chemicals and presentations matching a name (case-insensitive) = drug_details(name= "...")
Or
All chemicals and presentations matching a code = drug_details(chemical_or_presentation_code= "...")
Or
All BNF sections matching a code = drug_details(BNF_section_code= "...")
Or
All BNF sections, chemicals and presentations exactly matching a name or code = drug_details(exact_name_or_code= "...")

Or a variation of the above (with at least 1 name, chemical_or_presentation_code, BNF_section_code, or exact_name_or_code).
N.B For now the use of multiple terms in one category requires "&q=", e.g 
drug_details(name="lipid&q=drug")
```{r}
drug_details <- function(name = NULL, chemical_or_presentation_code = NULL, BNF_section_code = NULL, exact_name_or_code = NULL){
  if (!is.null(name)){variablesegment1 <- str_c("&q=", name)}
  if (!is.null(chemical_or_presentation_code)){variablesegment2 <- str_c("&q=", chemical_or_presentation_code)} 
  if (!is.null(BNF_section_code)){variablesegment3 <- str_c("&q=", BNF_section_code)}
  if (!is.null(exact_name_or_code)){variablesegment4 <- str_c("&q=", exact_name_or_code, "&exact=true")}
  variablesegment <- str_c(
  if(exists("variablesegment1")){variablesegment1},
  if(exists("variablesegment2")){variablesegment2},
  if(exists("variablesegment3")){variablesegment3},
  if(exists("variablesegment4")){variablesegment4})

str_c("https://openprescribing.net/api/1.0/bnf_code/?", variablesegment, "&format=csv") %>%
getURL() %>%
textConnection() %>%
read.csv()
}
```

##Organisation Codes
Search for details about a CCG or practice by code or name.
E.g All organisations matching a code or name = organisation_codes(organisation_code_or_name= "...")
Or
All CCGs matching a code or name = organisation_codes(CCG_code_or_name= "...")
Or
All practices matching a code or name = organisation_codes(practice_code_or_name= "...")
Or
All organisations exactly matching a code or name = organisation_codes(exact_name_or_code= "...")

Or a variation of the above (with at least 1 organisation_code_or_name, CCG_code_or_name, practice_code_or_name, or exact_name_or_code).
N.B For now the use of multiple terms in one category requires "&q=", e.g 
organisation_codes(organisation_code_or_name= "Beaumont&q=Gloucester")
```{r}
organisation_codes <- function(organisation_code_or_name = NULL, CCG_code_or_name = NULL, practice_code_or_name = NULL, exact_name_or_code = NULL){
  if (!is.null(organisation_code_or_name)){variablesegment1 <- str_c("&q=", organisation_code_or_name)}
  if (!is.null(CCG_code_or_name)){variablesegment2 <- str_c("&q=", CCG_code_or_name, "&org_type=CCG")} 
  if (!is.null(practice_code_or_name)){variablesegment3 <- str_c("&q=", practice_code_or_name, "&org_type=practice")}
  if (!is.null(exact_name_or_code)){variablesegment4 <- str_c("exact=true", "&q=", exact_name_or_code)}
  variablesegment <- str_c(
  if(exists("variablesegment1")){variablesegment1},
  if(exists("variablesegment2")){variablesegment2},
  if(exists("variablesegment3")){variablesegment3},
  if(exists("variablesegment4")){variablesegment4})

str_c("https://openprescribing.net/api/1.0/org_code/?", variablesegment, "&format=csv") %>%
getURL() %>%
textConnection() %>%
read.csv()
}
```

##List size and ASTRO_PUs by CCG or practice
Search for details about a CCG or practice by code or name. Returns values for all months available.
E.g Total list size for all CCGs = list_size()
Or
Total list size for all practices by practice code, or CCG code = list_size(list_size_by_code= "...")
Or
ASTRO-PU cost and items for practices by practice code, or CCG code = list_size(ASTRO_PU_by_code= "...")

Or a variation of the above.
```{r}
list_size <- function(list_size_by_code = NULL, ASTRO_PU_by_code = NULL){
  
  if (is.null(list_size_by_code)&is.null(ASTRO_PU_by_code)){variablesegment1 <- str_c("ccg&keys=total_list_size")}
  if (!is.null(list_size_by_code)){variablesegment2 <- str_c("practice&org=", list_size_by_code, "&keys=total_list_size")} 
  if (!is.null(ASTRO_PU_by_code)){variablesegment3 <- str_c("practice&org=", ASTRO_PU_by_code, "&keys=astro_pu_items,astro_pu_cost")}
  variablesegment <- str_c(
  if(exists("variablesegment1")){variablesegment1},
  if(exists("variablesegment2")){variablesegment2},
  if(exists("variablesegment3")){variablesegment3})
  
str_c("https://openprescribing.net/api/1.0/org_details/?org_type=", variablesegment, "&format=csv") %>%
getURL() %>%
textConnection() %>%
read.csv()
}
```

#For example
```{r}
list_size(list_size_by_code = "03V")
```

##CCG Boundraries are unavailable for now
THe only thing I haven't sorted is the CCG Boundaries, "Search for the boundaries of a CCG, or location of a practice, by code. Returns GeoJSON."